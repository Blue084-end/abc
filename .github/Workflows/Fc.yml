name: Android CI Full Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  android-scan:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: gradle

    - name: ğŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew

    # ğŸ§ª Android Lint
    - name: ğŸ§ª Run Android Lint
      run: ./gradlew lint

    # ğŸ“ Static Code Analysis: Checkstyle & PMD
    - name: ğŸ“ Run Checkstyle
      run: ./gradlew checkstyle

    - name: ğŸ§  Run PMD
      run: ./gradlew pmd

    # ğŸ SpotBugs / FindBugs
    - name: ğŸ Run SpotBugs
      run: ./gradlew spotbugsMain

    # ğŸ” Security Scan: SonarQube
    - name: ğŸ” Run SonarQube Scan
      run: ./gradlew sonar
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    # ğŸ§¬ Dependency Scan: OWASP
    - name: ğŸ§¬ Run OWASP Dependency Check
      run: |
        mkdir -p dependency-check
        wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
        unzip dependency-check-8.4.0-release.zip -d dependency-check
        ./dependency-check/bin/dependency-check.sh --project "AndroidApp" --scan ./app

    # ğŸ“Š Code Coverage: Jacoco
    - name: ğŸ“Š Run Jacoco Coverage
      run: ./gradlew jacocoTestReport

    # ğŸ§© Custom Rules Scan: Detekt (Kotlin)
    - name: ğŸ§© Run Detekt
      run: ./gradlew detekt

    # ğŸ›¡ï¸ Manifest & Permission Scan (MobSF placeholder)
    - name: ğŸ›¡ï¸ Manifest Scan (custom script)
      run: |
        grep -i "<uses-permission" app/src/main/AndroidManifest.xml || echo "No permissions found"

    # ğŸ” Secrets Scan
    - name: ğŸ” Run Secrets Scan
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml

    # ğŸ§¯ Runtime Scan: StrictMode & LeakCanary (placeholder)
    - name: ğŸ§¯ Runtime Scan Reminder
      run: echo "StrictMode & LeakCanary should be configured in app code and tested during instrumentation tests"

    # ğŸ§  CPD (Copy-Paste Detector)
    - name: ğŸ§  Run CPD
      run: ./gradlew cpdCheck

    # ğŸ“‹ Show Environment Info
    - name: ğŸ“‹ Show Java & Gradle Info
      run: |
        java -version
        ./gradlew --version
